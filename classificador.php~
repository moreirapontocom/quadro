<?php
/*
 * Plugin Name: Classificador
 * Plugin URI: http://Endereço_da_pagina
 * Description: Plugin que permite criar grupos de informações, como filias de empresas
 * Version: 1.0
 * Author: Lucas Moreira de Souza
 * Author URI: http://lucasmoreira.com.br
 *
 * Copyright 2012 Lucas Moreira de Souza <moreirapontocom at gmail dot com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 * MA 02110-1301, USA.
 */

class classificador {

    private static $wpdb;
    private static $info;
    
    public function inicializar() {
        global $wpdb;

        classificador::$wpdb = $wpdb;
        classificador::$info['plugin_fpath'] = dirname(__FILE__);
    }

    public function ativar() {
        if (is_null(classificador::$wpdb))
            classificador::inicializar();

        // cria a base de dados
        $sqlSuper = "
            CREATE TABLE IF NOT EXISTS `".classificador::$wpdb->prefix."sg_super` (
              `id` smallint(6) unsigned NOT NULL AUTO_INCREMENT,
              `nome` varchar(200) NOT NULL,
              PRIMARY KEY (`id`)
            ) ENGINE=MyISAM AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC";
            
        $sqlGrupos = "
            CREATE TABLE IF NOT EXISTS `".classificador::$wpdb->prefix."sg_grupos` (
              `id` smallint(6) unsigned NOT NULL AUTO_INCREMENT,
              `id_super` smallint UNSIGNED NOT NULL,
              `nome` varchar(200) NOT NULL,
              PRIMARY KEY (`id`)
            ) ENGINE=MyISAM AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC";

        $sqlItens = "
            CREATE TABLE IF NOT EXISTS `".classificador::$wpdb->prefix."sg_itens` (
              `id` smallint(6) unsigned NOT NULL AUTO_INCREMENT,
              `id_grupo` smallint(6) unsigned NOT NULL,
              `nome` varchar(200) NOT NULL,
              `imagem` varchar(255) NOT NULL,
              `detalhes` text,
              PRIMARY KEY (`id`)
            ) ENGINE=MyISAM AUTO_INCREMENT=5 DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC";

        classificador::$wpdb->query($sqlSuper);
        classificador::$wpdb->query($sqlGrupos);
        classificador::$wpdb->query($sqlItens);
   }

    public function desativar() {
        if (is_null(classificador::$wpdb))
            classificador::inicializar();
            
        $sqlSuper  = "DROP TABLE `".classificador::$wpdb->prefix."sg_super`";
        $sqlGrupos = "DROP TABLE `".classificador::$wpdb->prefix."sg_grupos`";
        $sqlItens = "DROP TABLE `".classificador::$wpdb->prefix."sg_itens`";
        
        classificador::$wpdb->query($sqlSuper);
        classificador::$wpdb->query($sqlGrupos);
        classificador::$wpdb->query($sqlItens);
    }

    public function criar_menu() {
        //add_menu_page('titulo classificador','classificador', 'Classificador', 10, 'classificador/supergroups.php');
        if ( function_exists('add_menu_page') )
            add_menu_page('titulo classificador', 'Classificador', 10, 'classificador/supergroups.php');
        
        if ( function_exists('add_submenu_page') ) {
            add_submenu_page('classificador/supergroups.php', 'Conjuntos', 'Conjuntos', 10, 'classificador/supergroups.php');
            add_submenu_page('classificador/supergroups.php', 'Grupos'   , 'Grupos'   , 10, 'classificador/groups.php');
            add_submenu_page('classificador/supergroups.php', 'Itens'    , 'Itens'    , 10, 'classificador/itens.php');
            add_submenu_page('classificador/supergroups.php', 'Sobre'    , 'Sobre'    , 10, 'classificador/about.php');
        }
    }
    
    
    
    
    
    
    // super grupo
    public function cria_super_grupo($nome='') {
        if (is_null(classificador::$wpdb))
            classificador::inicializar();
        
        $sql = "INSERT INTO `".classificador::$wpdb->prefix."sg_super` (nome) VALUES ('".$nome."')";
        if ( classificador::$wpdb->query($sql) )
            return true;
        else
            return false;
    }

    public function lista_super_grupos() {
        if ( is_null(classificador::$wpdb) )
            classificador::inicializar();
        
        $sql = "SELECT * FROM `".classificador::$wpdb->prefix."sg_super` ORDER BY nome ASC";
        $results = classificador::$wpdb->get_results($sql);
        if ( $results )
            return $results;
        else
            return false;
        
    }
    // end super grupo
    
    // grupos
    public function cria_grupo($nome='',$super='') {
        if (is_null(classificador::$wpdb))
            classificador::inicializar();
        
        $sql = "INSERT INTO `".classificador::$wpdb->prefix."sg_grupos` (nome,id_super) VALUES ('".$nome."','".$super."')";
        if ( classificador::$wpdb->query($sql) )
            return true;
        else
            return false;
    }

    public function lista_grupos() {
        if ( is_null(classificador::$wpdb) )
            classificador::inicializar();
        
        $sql = "SELECT * FROM `".classificador::$wpdb->prefix."sg_grupos` ORDER BY nome ASC";
        $results = classificador::$wpdb->get_results($sql);
        if ( $results )
            return $results;
        else
            return false;
    }
    // end grupos
    
    // itens
    public function cria_item($nome='',$grupo='') {
        if ( is_null(classificador::$wpdb) )
            classificador::inicializar();
        
        $sql = "INSERT INTO `".classificador::$wpdb->prefix."sg_itens` (id_grupo,nome) VALUES ('".$grupo."','".$nome."')";
        if ( classificador::$wpdb->query($sql) )
            return true;
        else
            return false;
    }
    
    public function lista_itens() {
        if ( is_null(classificador::$wpdb) )
            classificador::inicializar();
        
        $sql = "
            SELECT
              ".classificador::$wpdb->prefix."sg_itens.*,
              ".classificador::$wpdb->prefix."sg_super.nome AS super,
              ".classificador::$wpdb->prefix."sg_grupos.nome AS grupo
            FROM ".classificador::$wpdb->prefix."sg_itens
            JOIN ".classificador::$wpdb->prefix."sg_grupos ON ".classificador::$wpdb->prefix."sg_itens.id_grupo = ".classificador::$wpdb->prefix."sg_grupos.id
            JOIN ".classificador::$wpdb->prefix."sg_super ON ".classificador::$wpdb->prefix."sg_grupos.id_super = ".classificador::$wpdb->prefix."sg_super.id
            ORDER BY ".classificador::$wpdb->prefix."sg_itens.id_grupo, ".classificador::$wpdb->prefix."sg_itens.nome ASC
        ";
        $results = classificador::$wpdb->get_results($sql);
        if ( $results )
            return $results;
        else
            return false;
    }
    // end itens

} // end class

$pathPlugin = substr(strrchr(dirname(__FILE__),DIRECTORY_SEPARATOR),1).DIRECTORY_SEPARATOR.basename(__FILE__);

add_action('admin_menu', array('classificador', 'criar_menu'));
register_activation_hook($pathPlugin, array('classificador', 'ativar'));      // activation
register_deactivation_hook($pathPlugin, array('classificador', 'desativar')); // deactivation
?>
